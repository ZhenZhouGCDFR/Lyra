name: Build AdGuardHome (Linux amd64 + arm64)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: amd64
          - os: ubuntu-22.04-arm64
            arch: arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.6'
          cache: false

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: go-${{ matrix.arch }}-${{ hashFiles('**/go.sum') }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang llvm lld \
            build-essential \
            ca-certificates

      - name: Build AdGuardHome
        shell: bash
        run: |
          set -euo pipefail
          git clone https://github.com/AdguardTeam/AdGuardHome.git
          mkdir -p build
          cd AdGuardHome

          export GOOS=linux
          export GOARCH=${{ matrix.arch }}
          export CGO_ENABLED=1
          export CC=clang
          export CXX=clang++
          export LD=ld.lld
          export SIGN=0

          if [ "$GOARCH" = "amd64" ]; then
            export CGO_CFLAGS="-O3 -march=x86-64-v3 -mtune=haswell \
              -funroll-loops -flto -fomit-frame-pointer -ffast-math \
              -fPIC -falign-functions=128 \
              -fno-unwind-tables -fno-asynchronous-unwind-tables \
              -ffunction-sections -fdata-sections"
            export CGO_LDFLAGS="-flto -fuse-ld=lld \
              -Wl,-O1 -Wl,--gc-sections -Wl,--icf=safe \
              -Wl,-z,max-page-size=0x1000"
          else
            export CGO_CFLAGS="-O3 \
              -funroll-loops -flto -fomit-frame-pointer -ffast-math \
              -fPIC -falign-functions=128 \
              -fno-unwind-tables -fno-asynchronous-unwind-tables \
              -ffunction-sections -fdata-sections"
            export CGO_LDFLAGS="-flto \
              -Wl,-O1 -Wl,--gc-sections \
              -Wl,-z,max-page-size=0x1000"
          fi

          go mod download

          OUTPUT="../build/AdGuardHome-linux-${GOARCH}"

          go build \
            -trimpath \
            -ldflags "-s -w -X main.Version=Lyra@Tkocean -extldflags='${CGO_LDFLAGS}'" \
            -o "$OUTPUT" \
            main.go

          strip "$OUTPUT" || true
          file "$OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: AdGuardHome-linux-${{ matrix.arch }}
          path: build/AdGuardHome-linux-${{ matrix.arch }}
