name: Build AdGuardHome (Linux amd64 + arm64)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]

    steps:
      - name: Checkout workflow repository
        uses: actions/checkout@v4

      - name: Clone AdGuardHome source
        run: git clone https://github.com/AdguardTeam/AdGuardHome.git

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.6'
          cache: false

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: go-${{ matrix.arch }}-${{ hashFiles('**/go.sum') }}

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang llvm lld build-essential ca-certificates gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Build AdGuardHome
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build
          cd AdGuardHome

          export GOOS=linux
          export CGO_ENABLED=1
          export CC=clang
          export CXX=clang++
          export SIGN=0

          if [ "${{ matrix.arch }}" = "amd64" ]; then
            export GOARCH=amd64
            export CGO_CFLAGS="-O3 -march=x86-64-v3 -mtune=haswell -funroll-loops -flto -fomit-frame-pointer -ffast-math -fPIC -falign-functions=128 -fno-unwind-tables -fno-asynchronous-unwind-tables -ffunction-sections -fdata-sections"
            export CGO_LDFLAGS="-flto"
          else
            export GOARCH=arm64
            export CC=aarch64-linux-gnu-gcc
            export CXX=aarch64-linux-gnu-g++
            export CGO_CFLAGS="-O3 -funroll-loops -flto -fomit-frame-pointer -ffast-math -fPIC -falign-functions=128 -fno-unwind-tables -fno-asynchronous-unwind-tables -ffunction-sections -fdata-sections"
            export CGO_LDFLAGS="-flto"
          fi

          go mod download

          OUTPUT="../build/AdGuardHome-linux-${GOARCH}"

          go build -trimpath -ldflags "-s -w -X main.Version=Lyra@Tkocean" -o "$OUTPUT" main.go

          strip "$OUTPUT" || true
          file "$OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: AdGuardHome-linux-${{ matrix.arch }}
          path: build/AdGuardHome-linux-${{ matrix.arch }}
