name: Build sing-box ( rules.srs )

on:
  workflow_dispatch:
    inputs:
      singbox_version:
        description: 'Sing-box version to use'
        required: true
        default: '1.12.13'
      rule_url:
        description: 'URL of sing-box JSON rule'
        required: true
        default: 'https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Singbox.json'
      output_name:
        description: 'Output SRS file name'
        required: true
        default: 'fuckad.srs'

  schedule:
    - cron: '0 22 * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup sing-box
        run: |
          set -e
          VERSION=${{ github.event.inputs.singbox_version }}
          VERSION_FILE="rule/.singbox_version"
          mkdir -p rule
          if [ -f "$VERSION_FILE" ] && [ "$(cat $VERSION_FILE)" = "$VERSION" ]; then
            echo "sing-box version $VERSION already installed, skipping download."
          else
            echo "Installing sing-box version $VERSION ..."
            curl -L -o sing-box.tar.gz \
              https://github.com/SagerNet/sing-box/releases/download/v${VERSION}/sing-box-${VERSION}-linux-amd64.tar.gz
            tar -xzf sing-box.tar.gz
            sudo mv sing-box-${VERSION}-linux-amd64/sing-box /usr/local/bin/sing-box
            sing-box version
            echo $VERSION > "$VERSION_FILE"
          fi

      - name: Compile rule-set to SRS
        run: |
          set -e
          mkdir -p rule
          RULE_URL=${{ github.event.inputs.rule_url }}
          OUTPUT_NAME=${{ github.event.inputs.output_name }}
          TEMP_JSON=temp_fuckad.json
          echo "Downloading $RULE_URL to $TEMP_JSON ..."
          curl -L -o $TEMP_JSON "$RULE_URL"
          echo "Compiling $TEMP_JSON to rule/$OUTPUT_NAME ..."
          sing-box rule-set compile $TEMP_JSON -o "rule/$OUTPUT_NAME"
          rm $TEMP_JSON
          echo "Compiled successfully. Contents of rule/:"
          ls -l rule/

      - name: Commit generated SRS if changed
        run: |
          set -e
          OUTPUT_NAME=${{ github.event.inputs.output_name }}
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add "rule/$OUTPUT_NAME"
          if ! git diff --cached --quiet; then
            git commit -m "build: update $OUTPUT_NAME (sing-box v${{ github.event.inputs.singbox_version }})"
            git push
          else
            echo "No changes detected in $OUTPUT_NAME, skipping commit."

