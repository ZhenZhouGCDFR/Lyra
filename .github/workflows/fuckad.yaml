name: Build sing-box ( rules.srs )

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      singbox_version:
        required: true
        default: '1.12.13'
      rule_url:
        required: true
        default: 'https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Singbox.json'
      output_name:
        required: true
        default: 'fuckad.srs'
      output_dir:
        required: false
        default: 'lib'
  schedule:
    - cron: '0 22 * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Cache sing-box
        uses: actions/cache@v4
        with:
          path: ~/.cache/sing-box
          key: sing-box-${{ github.event.inputs.singbox_version }}

      - name: Setup sing-box
        run: |
          set -e
          VERSION=${{ github.event.inputs.singbox_version }}
          BIN_DIR=$HOME/.cache/sing-box/$VERSION
          BIN_PATH=$BIN_DIR/sing-box
          if [ ! -x "$BIN_PATH" ]; then
            mkdir -p "$BIN_DIR"
            curl -L -o sing-box.tar.gz https://github.com/SagerNet/sing-box/releases/download/v${VERSION}/sing-box-${VERSION}-linux-amd64.tar.gz
            tar -xzf sing-box.tar.gz
            mv sing-box-${VERSION}-linux-amd64/sing-box "$BIN_PATH"
            chmod +x "$BIN_PATH"
          fi
          sudo ln -sf "$BIN_PATH" /usr/local/bin/sing-box

      - name: Compile rule-set
        run: |
          set -e
          cd "$GITHUB_WORKSPACE"

          RULE_URL=${{ github.event.inputs.rule_url }}
          OUTPUT_NAME=${{ github.event.inputs.output_name }}
          OUTPUT_DIR=${{ github.event.inputs.output_dir }}

          mkdir -p "$OUTPUT_DIR"

          TEMP_JSON="$OUTPUT_DIR/temp_${OUTPUT_NAME%.srs}.json"

          curl -L -o "$TEMP_JSON" "$RULE_URL"
          sing-box rule-set compile "$TEMP_JSON" -o "$OUTPUT_DIR/$OUTPUT_NAME"
          rm -f "$TEMP_JSON"

      - name: Commit result
        run: |
          set -e
          cd "$GITHUB_WORKSPACE"

          OUTPUT_NAME=${{ github.event.inputs.output_name }}
          OUTPUT_DIR=${{ github.event.inputs.output_dir }}

          git config user.name github-actions
          git config user.email actions@github.com
          git add "$OUTPUT_DIR/$OUTPUT_NAME"

          if ! git diff --cached --quiet; then
            git commit -m "build: update $OUTPUT_NAME"
            git push
          fi

