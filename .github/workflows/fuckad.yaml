name: Build sing-box ( rules.srs )

on:
  workflow_dispatch:
    inputs:
      singbox_version:
        required: false
        default: '1.12.13'
      rule_url:
        required: false
        default: 'https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Singbox.json'
      output_name:
        required: false
        default: 'fuckad.srs'
  schedule:
    - cron: '0 22 * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup sing-box
        run: |
          set -e
          cd $GITHUB_WORKSPACE
          VERSION=${{ github.event.inputs.singbox_version }}
          VERSION_FILE="rule/.singbox_version"
          mkdir -p rule
          if [ -f "$VERSION_FILE" ] && [ "$(cat $VERSION_FILE)" = "$VERSION" ]; then
            echo "sing-box version $VERSION already installed, skipping download."
          else
            curl -L -o sing-box.tar.gz https://github.com/SagerNet/sing-box/releases/download/v${VERSION}/sing-box-${VERSION}-linux-amd64.tar.gz
            tar -xzf sing-box.tar.gz
            sudo mv sing-box-${VERSION}-linux-amd64/sing-box /usr/local/bin/sing-box
            echo $VERSION > "$VERSION_FILE"
          fi

      - name: Compile rule-set to SRS
        run: |
          set -e
          cd $GITHUB_WORKSPACE
          mkdir -p rule
          RULE_URL=${{ github.event.inputs.rule_url }}
          OUTPUT_NAME=${{ github.event.inputs.output_name }}
          TEMP_JSON=rule/temp_fuckad.json
          curl -L -o $TEMP_JSON "$RULE_URL"
          sing-box rule-set compile $TEMP_JSON -o "rule/$OUTPUT_NAME"
          rm $TEMP_JSON

      - name: Commit generated SRS if changed
        run: |
          set -e
          cd $GITHUB_WORKSPACE
          OUTPUT_NAME=${{ github.event.inputs.output_name }}
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add "rule/$OUTPUT_NAME"
          if ! git diff --cached --quiet; then
            git commit -m "build: update $OUTPUT_NAME (sing-box v${{ github.event.inputs.singbox_version }})"
            git push
