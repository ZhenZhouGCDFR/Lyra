name: Build Mihomo (Android arm64 + Windows x64)

on:
  workflow_dispatch:
    inputs:
      go_version:
        description: 'Go version'
        required: true
        default: '1.25.5'

jobs:
  android:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-go@v5
      with:
        go-version: ${{ inputs.go_version }}

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang llvm lld unzip curl git

    - name: Cache Android NDK
      uses: actions/cache@v4
      with:
        path: ~/.cache/android-ndk-r26d
        key: android-ndk-r26d

    - name: Setup Android NDK
      run: |
        set -e
        NDK_CACHE="$HOME/.cache/android-ndk-r26d"
        NDK_PATH="$NDK_CACHE/android-ndk-r26d"
        if [ ! -d "$NDK_PATH" ]; then
          mkdir -p "$NDK_CACHE"
          curl -L https://dl.google.com/android/repository/android-ndk-r26d-linux.zip -o ndk.zip
          unzip -q ndk.zip -d "$NDK_CACHE"
        fi

    - name: Clone Mihomo Alpha
      run: |
        git clone https://github.com/MetaCubeX/mihomo.git
        cd mihomo
        git fetch --depth=1 origin Alpha
        git checkout Alpha
        git submodule update --init --recursive

    - name: Build Android arm64
      shell: bash
      run: |
        set -euo pipefail
        NDK="$HOME/.cache/android-ndk-r26d/android-ndk-r26d"
        TOOLCHAIN="$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin"
        export GOOS=android
        export GOARCH=arm64
        export CGO_ENABLED=1
        export CC="$TOOLCHAIN/aarch64-linux-android21-clang"
        export CXX="$TOOLCHAIN/aarch64-linux-android21-clang++"
        export AR="$TOOLCHAIN/llvm-ar"
        export LD="$TOOLCHAIN/ld.lld"
        export CGO_CFLAGS="-O3 -march=armv8-a+crypto -funroll-loops -flto -fomit-frame-pointer -ffast-math -fPIC -falign-functions=128 -fno-unwind-tables -fno-asynchronous-unwind-tables -ffunction-sections -fdata-sections"
        export CGO_LDFLAGS="-flto -ldl -Wl,-O1 -Wl,--gc-sections -Wl,--icf=safe -Wl,-z,max-page-size=0x1000"
        cd mihomo
        go mod download
        go build -trimpath -ldflags "-s -w" -o mihomo-android-arm64

    - uses: actions/upload-artifact@v4
      with:
        name: android-arm64
        path: mihomo-android-arm64

  windows:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-go@v5
      with:
        go-version: ${{ inputs.go_version }}

    - name: Cache llvm-mingw
      uses: actions/cache@v4
      with:
        path: ~/.cache/llvm-mingw
        key: llvm-mingw-20240320-x64

    - name: Setup llvm-mingw
      shell: bash
      run: |
        set -e
        TOOLCHAIN_CACHE="$HOME/.cache/llvm-mingw"
        TOOLCHAIN_PATH="$TOOLCHAIN_CACHE/llvm-mingw-20240320-msvcrt-x86_64"
        if [ ! -d "$TOOLCHAIN_PATH" ]; then
          mkdir -p "$TOOLCHAIN_CACHE"
          curl -L https://github.com/mstorsjo/llvm-mingw/releases/download/20240320/llvm-mingw-20240320-msvcrt-x86_64.zip -o llvm-mingw.zip
          unzip -q llvm-mingw.zip -d "$TOOLCHAIN_CACHE"
        fi

    - name: Clone Mihomo Alpha
      shell: bash
      run: |
        git clone https://github.com/MetaCubeX/mihomo.git
        cd mihomo
        git fetch --depth=1 origin Alpha
        git checkout Alpha
        git submodule update --init --recursive

    - name: Build Windows x64
      shell: bash
      run: |
        set -euo pipefail
        TOOLCHAIN="$HOME/.cache/llvm-mingw/llvm-mingw-20240320-msvcrt-x86_64/bin"
        export GOOS=windows
        export GOARCH=amd64
        export CGO_ENABLED=1
        export CC="$TOOLCHAIN/x86_64-w64-mingw32-clang"
        export CXX="$TOOLCHAIN/x86_64-w64-mingw32-clang++"
        export AR="$TOOLCHAIN/llvm-ar"
        export LD="$TOOLCHAIN/ld.lld"
        export CGO_CFLAGS="-O3 -march=x86-64-v3 -funroll-loops -flto -falign-functions=128 -falign-jumps=64 -falign-loops=64 -fomit-frame-pointer -ffast-math -fno-exceptions -fno-unwind-tables -fno-asynchronous-unwind-tables -ffunction-sections -fdata-sections"
        export CGO_LDFLAGS="-flto -Wl,-O1 -Wl,--gc-sections -Wl,--icf=safe -Wl,-z,max-page-size=0x1000"
        cd mihomo
        go mod download
        go build -trimpath -ldflags "-s -w" -o mihomo-windows-x64.exe

    - uses: actions/upload-artifact@v4
      with:
        name: windows-x64
        path: mihomo-windows-x64.exe
