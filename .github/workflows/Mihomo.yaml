name: Build Mihomo

on:
  workflow_dispatch:
    inputs:
      go_version:
        description: 'Go version'
        required: true
        default: '1.25.5'

jobs:
  android:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go_version }}

      - name: Install Android NDK and deps
        run: |
          sudo apt update
          sudo apt install -y clang llvm lld unzip curl git
          curl -L https://dl.google.com/android/repository/android-ndk-r26d-linux.zip -o ndk.zip
          unzip -q ndk.zip
        shell: bash

      - name: Build Android
        shell: bash
        run: |
          export NDK="$GITHUB_WORKSPACE/android-ndk-r26d"
          export TOOLCHAIN="$NDK/toolchains/llvm/prebuilt/linux-x86_64/bin"
          export GOOS=android GOARCH=arm64 CGO_ENABLED=1
          export CC="$TOOLCHAIN/aarch64-linux-android21-clang"
          export CXX="$TOOLCHAIN/aarch64-linux-android21-clang++"
          cd mihomo
          go mod download
          go build -trimpath -ldflags "-s -w" -o "../mihomo-android-arm64"
        working-directory: ${{ github.workspace }}

      - uses: actions/upload-artifact@v4
        with:
          name: android-arm64
          path: mihomo-android-arm64

  windows:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go_version }}

      - name: Setup llvm-mingw
        run: |
          curl -L https://github.com/mstorsjo/llvm-mingw/releases/download/20240320/llvm-mingw-20240320-msvcrt-x86_64.zip -o llvm-mingw.zip
          unzip -q llvm-mingw.zip -d llvm-mingw
        shell: bash

      - name: Build Windows
        shell: bash
        run: |
          export TOOLCHAIN="$GITHUB_WORKSPACE/llvm-mingw/llvm-mingw-20240320-msvcrt-x86_64/bin"
          export GOOS=windows GOARCH=amd64 CGO_ENABLED=1
          export CC="$TOOLCHAIN/x86_64-w64-mingw32-clang"
          export CXX="$TOOLCHAIN/x86_64-w64-mingw32-clang++"
          cd mihomo
          go mod download
          go build -trimpath -ldflags "-s -w" -o "../mihomo-windows-x64.exe"
        working-directory: ${{ github.workspace }}

      - uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: mihomo-windows-x64.exe
